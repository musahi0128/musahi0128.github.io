<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Zabbix: monitor host over SSH</title>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />

<link rel="stylesheet" href="/application.a042f2dd3efc476ed4ca880aee2b0ad9c0cbb87c6eb11bb0fcb97d62e6099988.css" integrity="sha256-oELy3T78R27UyogK7isK2cDLuHxusRuw/Ll9YuYJmYg=" />





  

  
  
  
    
  
  

  <link rel="icon" type="image/png" href="/images/site/android-chrome-512x512_hu15959206232224009283.png" />

<meta property="og:url" content="http://localhost:1313/posts/monitoring/zabbix-host-ssh/">
  <meta property="og:site_name" content="Moh. Sarip Hidayat, S.Tr.Kom">
  <meta property="og:title" content="Zabbix: monitor host over SSH">
  <meta property="og:description" content="An approach to configure Zabbix Agent connectivity with the server over SSH port forwarding">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-12-13T22:37:00+07:00">
    <meta property="article:modified_time" content="2024-12-13T22:37:00+07:00">

    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Zabbix: monitor host over SSH">
  <meta name="twitter:description" content="An approach to configure Zabbix Agent connectivity with the server over SSH port forwarding">

    
    
<meta name="description" content="An approach to configure Zabbix Agent connectivity with the server over SSH port forwarding" />



    

    
        
            
            

            
            

            
            
                
                    <script data-goatcounter="https://musahi0128.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
                    
            

            
            

            

            

            
        
    




<script>
      theme = localStorage.getItem('theme-scheme') || localStorage.getItem('darkmode:color-scheme') || 'light';
      if (theme == 'system') {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          theme = 'dark';
        } else {
          theme = 'light';
        }
      }
      document.documentElement.setAttribute('data-theme', theme);
    </script>
  </head>

  <body class="type-posts kind-page" data-bs-spy="scroll" data-bs-target="#TableOfContents" data-bs-offset="80">
    <div class="container-fluid bg-secondary wrapper">
      
      
    















  


  




  
  
    
  
  



  
  
    
  
  










  




  


<nav class="navbar navbar-expand-xl top-navbar shadow " id="top-navbar">
  <div class="container">
    
    <button class="navbar-toggler navbar-light" id="sidebar-toggler" type="button">
      <i data-feather="sidebar"></i>
    </button>
    
    <a class="navbar-brand" href="/">
      
        <img src="/images/site/android-chrome-512x512_hu15959206232224009283.png" id="logo" alt="Logo">
      Moh. Sarip Hidayat, S.Tr.Kom</a>
    <button
      class="navbar-toggler navbar-light"
      id="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#top-nav-items"
      aria-label="menu"
    >
      <i data-feather="menu"></i>
    </button>

    <div class="collapse navbar-collapse dynamic-navbar" id="top-nav-items">
      <ul class="nav navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="/#home">Home</a>
        </li>
        
          
          
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#about">About</a>
                </li>
              
            
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#skills">Skills</a>
                </li>
              
            
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#experiences">Experiences</a>
                </li>
              
            
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#education">Education</a>
                </li>
              
            
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#projects">Projects</a>
                </li>
              
            
            
            
            
            
              
              
                <li class="nav-item">
                  <a class="nav-link" href="/#accomplishments">Accomplishments</a>
                </li>
              
            
            
          
        
        
          <div id="top-navbar-divider"></div>
        
        
          <li class="nav-item">
            <a class="nav-link" id="blog-link" href="/posts">Posts</a>
          </li>
        
        
        
        
        
          



  
  


<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle"  href="#" id="themeSelector" role="button"
  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
  <img id="navbar-theme-icon-svg" class="theme-icon" src="/icons/moon-svgrepo-com.svg" width=20 alt="Dark Theme">
</a>
<div id="themeMenu" class="dropdown-menu dropdown-menu-icons-only" aria-labelledby="themeSelector">
  
  <a class="dropdown-item nav-link" href="#" data-scheme="light">
    <img class="theme-icon" src="/icons/sun-svgrepo-com.svg" width=20 alt="Light Theme">
  </a>
  
  
  <a class="dropdown-item nav-link" href="#" data-scheme="dark">
    <img class="theme-icon" src="/icons/moon-svgrepo-com.svg" width=20 alt="Dark Theme">
  </a>
  
  
  <a class="dropdown-item nav-link" href="#" data-scheme="system">
    <img class="theme-icon" src="/icons/computer-svgrepo-com.svg" width=20 alt="System Theme">
  </a>
  
</div>
</li>

        
      </ul>
    </div>
  </div>
  
  
    <img src="/images/site/android-chrome-512x512_hu15959206232224009283.png" class="d-none" id="main-logo" alt="Logo">
  
  
    <img src="/images/site/android-chrome-512x512_hu15959206232224009283.png" class="d-none" id="inverted-logo" alt="Inverted Logo">
  
</nav>



      
      
  <section class="sidebar-section" id="sidebar-section">
    <div class="sidebar-holder">
      <div class="sidebar" id="sidebar">
        <form class="mx-auto" method="get" action="/search">
          <input type="text" name="keyword" value="" placeholder="Search" data-search="" id="search-box" />
        </form>
        <div class="sidebar-tree">
          <ul class="tree" id="tree">
            <li id="list-heading"><a href="/posts/" data-filter="all">Posts</a></li>
            <div class="subtree">
                
  
  
  
  
  
    
    <li>
      <i data-feather="plus-circle"></i><a class=" list-link" href="/posts/os/"> Operating systems</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li>
      <i data-feather="plus-circle"></i><a class=" list-link" href="/posts/os/ubuntu/"> Ubuntu</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class=" list-link" href="/posts/os/ubuntu/xfce4-papirus-dracula/" title="Xfce4 &#43; Papirus icon &#43; Dracula theme = ðŸ–¤">Xfce4 &#43; Papirus icon &#43; Dracula theme = ðŸ–¤</a></li>
  

  
  
  
  
  
    
    <li><a class=" list-link" href="/posts/os/ubuntu/vncserver_headless/" title="VNC on headless VM or container">VNC on headless VM or container</a></li>
  

  
  
  
  
  
    
    <li><a class=" list-link" href="/posts/os/ubuntu/vncserver_wsl2/" title="VNC on WSL2">VNC on WSL2</a></li>
  


      </ul>
    </li>
  


      </ul>
    </li>
  

  
  
  
  
    
    
  
  
    
    <li>
      <i data-feather="minus-circle"></i><a class="active list-link" href="/posts/monitoring/"> Monitoring</a>
      
      <ul class="active">
        
  
  
  
  
    
    
  
  
    
    <li><a class="active list-link" href="/posts/monitoring/zabbix-host-ssh/" title="Zabbix: monitor host over SSH">Zabbix: monitor host over SSH</a></li>
  

  
  
  
  
  
    
    <li><a class=" list-link" href="/posts/monitoring/zabbix-setup-script-noble-arm64/" title="Zabbix setup script for Ubuntu Noble ARM64/AArch64">Zabbix setup script for Ubuntu Noble ARM64/AArch64</a></li>
  


      </ul>
    </li>
  


            </div>
          </ul>
        </div>
      </div>
    </div>
  </section>


      
      
<section class="content-section" id="content-section">
  <div class="content">
    <div class="container p-0 read-area">
      
      <div class="hero-area col-sm-12" id="hero-area" style='background-image: url(/images/posts/zabbix-hero.png);'>
      </div>

      
      <div class="page-content">
        
        <div class="author-profile ms-auto align-self-lg-center">
          <img class="rounded-circle" src='/images/author/musahi0128_hu11034217487868332195.jpg' alt="Author Image">
          <h5 class="author-name">Moh. Sarip Hidayat, S.Tr.Kom</h5>
          <p class="text-muted">Friday, December 13, 2024 | 6 minutes</p>
        </div>
        

        <div class="title">
          <h1>Zabbix: monitor host over SSH</h1>
        </div>

        

        
          <div class="tags">
  <ul style="padding-left: 0;">
    
  </ul>
</div>

        
        <div class="post-content" id="post-content">
          <h2 id="background">Background</h2>
<p>Have you ever stumble upon a situation where you need to configure Zabbix host to be monitored but they are not on the same network?</p>
<p>Setting up a VPN network would be one of the most suggested approach. But let&rsquo;s says it isn&rsquo;t an option for you, or you don&rsquo;t want to do it that way for any reason.</p>
<p>One way to solve this problem is to setup SSH connection between the server and the monitored hosts, and then forward the Zabbix agent port (10050 by default) of the monitored host to a port on the server. This would work if your Zabbix server is accessible by its public IP and able to expose its SSH port. Refer to <a href="/posts/solution/monitoring/zabbix-setup-script-noble-arm64/">this post</a> on how to setup Zabbix server on a machine with ARM64/AArch64 processor and Ubuntu Noble operating system.</p>
<p>SSH client are available on Linux, Mac OS, and even on the lates version of Windows by default, so this would be a cross-platform solution.</p>
<p>We will harden the SSH installation on the server, and setup a user with no ability other than what is required to allow the port forwarding to happens. Those steps are required to reduce cyber security attack surface.</p>
<h2 id="setting-up">Setting up</h2>
<h3 id="on-the-server">On the server</h3>
<h4 id="harden-ssh-service-config">Harden SSH service config</h4>
<p>For starter, you can add or adjust following lines on your <code>/etc/ssh/sshd_config</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Protocol <span style="color:#ae81ff">2</span>                   <span style="color:#75715e"># Use only the secure SSH protocol version 2.</span>
</span></span><span style="display:flex;"><span>Port <span style="color:#ae81ff">12345</span>                   <span style="color:#75715e"># Set a high, non-default port to reduce exposure.</span>
</span></span><span style="display:flex;"><span>PermitRootLogin no           <span style="color:#75715e"># Disable root login for better security.</span>
</span></span><span style="display:flex;"><span>PasswordAuthentication no    <span style="color:#75715e"># Enforce key-based authentication only.</span>
</span></span><span style="display:flex;"><span>MaxAuthTries <span style="color:#ae81ff">3</span>               <span style="color:#75715e"># Limit to 3 failed login attempts per connection.</span>
</span></span><span style="display:flex;"><span>MaxSessions <span style="color:#ae81ff">2</span>                <span style="color:#75715e"># Allow up to 2 sessions per connection.</span>
</span></span><span style="display:flex;"><span>ClientAliveInterval <span style="color:#ae81ff">600</span>      <span style="color:#75715e"># Send keep-alive messages every 10 minutes of inactivity.</span>
</span></span><span style="display:flex;"><span>ClientAliveCountMax <span style="color:#ae81ff">3</span>        <span style="color:#75715e"># Disconnect after 30 minutes of inactivity.</span>
</span></span></code></pre></div><h4 id="prevent-brute-force-attack-with-fail2ban">Prevent brute-force attack with fail2ban</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install -yq fail2ban
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; &#39;EOF&#39; | sudo tee /etc/fail2ban/jail.local &gt; /dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[sshd]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled = true               # Enables the SSH jail.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">port = 12345                 # Sets the SSH port to 12345. Replace this with your actual SSH port.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">filter = sshd                # Specifies the filter to use, typically defined in /etc/fail2ban/filter.d/sshd.conf.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">logpath = /var/log/auth.log  # Specifies the log file to monitor for SSH login attempts.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">maxretry = 3                 # Allows up to 3 failed login attempts before banning the IP.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>sudo systemctl restart fail2ban
</span></span></code></pre></div><h4 id="setup-the-service-account">Setup the service account</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set the service account username</span>
</span></span><span style="display:flex;"><span>SERVICE_ACCOUNT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix_service_account&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Abort if the user already exists</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> id <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> &amp;&gt;/dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;User </span>$SERVICE_ACCOUNT<span style="color:#e6db74"> already exists. Aborting.&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create the user and set its shell to /bin/false so it can&#39;t have an interactive login session</span>
</span></span><span style="display:flex;"><span>sudo adduser --disabled-password --gecos <span style="color:#e6db74">&#34;&#34;</span> --shell /bin/false <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> &gt; /dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove the user from any other group membership</span>
</span></span><span style="display:flex;"><span>sudo usermod -G <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Prevent password-based login</span>
</span></span><span style="display:flex;"><span>sudo passwd -l <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> &gt; /dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate private/public key pair for the user</span>
</span></span><span style="display:flex;"><span>sudo -u <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> bash -c <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mkdir -p ~/.ssh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N &#34;&#34; -q
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    cp ~/.ssh/id_rsa.pub ~/.ssh/authorized_keys
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    chmod 700 ~/.ssh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    chmod 600 ~/.ssh/id_rsa ~/.ssh/authorized_keys
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    chmod 644 ~/.ssh/id_rsa.pub
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create a specific SSH server configuration for the user</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Those ports with PermitOpen represent each of the monitored hosts</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF | sudo tee /etc/ssh/sshd_config.d/101-${SERVICE_ACCOUNT}.conf &gt; /dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Match User ${SERVICE_ACCOUNT}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    AllowTcpForwarding yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    X11Forwarding no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    PermitTunnel no
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    PermitOpen 127.0.0.1:11051
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    PermitOpen 127.0.0.1:11052
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    PermitOpen 127.0.0.1:11053
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # PermitOpen 127.0.0.1:11054
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # PermitOpen 127.0.0.1:11055
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # Add more as needed, one line per monitored host
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Restart ssh service to apply the config</span>
</span></span><span style="display:flex;"><span>sudo systemctl restart ssh.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Print the private key; distribute this to the monitored hosts</span>
</span></span><span style="display:flex;"><span>sudo -u <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> bash -c <span style="color:#e6db74">&#39;cat ~/.ssh/id_rsa&#39;</span>
</span></span></code></pre></div><h3 id="on-the-monitored-host">On the monitored host</h3>
<p>Assuming you have installed the agent on the monitored host with Ubuntu-based operating system, you can use following script. It will setup the service account and a systemd user service to keep the port forwarding alive. The script might also work with other Linux-based operating system having <code>systemd</code> installed.</p>
<p>Before running this script, create a new file on your home directory named <code>id_rsa_${SERVICE_ACCOUNT}</code> (would be <code>id_rsa_zabbix_service_account</code> from the example above) and put the printed content of the private key from previous script. Delete this file after completing the setup.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Variables</span>
</span></span><span style="display:flex;"><span>SERVICE_ACCOUNT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zabbix_service_account&#34;</span>         <span style="color:#75715e"># User account for SSH tunnel</span>
</span></span><span style="display:flex;"><span>SERVER_ADDRESS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;179.155.104.113&#34;</span>                 <span style="color:#75715e"># Server&#39;s public IP</span>
</span></span><span style="display:flex;"><span>SERVER_PORT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;12345&#34;</span>                              <span style="color:#75715e"># Server&#39;s SSH port</span>
</span></span><span style="display:flex;"><span>REMOTE_PORT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;11051&#34;</span>                              <span style="color:#75715e"># Remote port to forward to</span>
</span></span><span style="display:flex;"><span>PRIVATE_KEY_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/id_rsa_</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># Path to private key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Abort if user already exists</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> id <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> &amp;&gt;/dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;User </span>$SERVICE_ACCOUNT<span style="color:#e6db74"> already exists. Aborting.&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create user</span>
</span></span><span style="display:flex;"><span>sudo adduser --disabled-password --gecos <span style="color:#e6db74">&#34;&#34;</span> --shell /usr/sbin/nologin <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> &gt; /dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove all group memberships</span>
</span></span><span style="display:flex;"><span>sudo usermod -G <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Lock password</span>
</span></span><span style="display:flex;"><span>sudo passwd -l <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> &gt; /dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable lingering for the user</span>
</span></span><span style="display:flex;"><span>sudo loginctl enable-linger <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Prepare SSH keys</span>
</span></span><span style="display:flex;"><span>sudo -u <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> bash -c <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mkdir -p ~/.ssh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    chmod 700 ~/.ssh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -f <span style="color:#e6db74">&#34;</span>$PRIVATE_KEY_PATH<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    sudo cp <span style="color:#e6db74">&#34;</span>$PRIVATE_KEY_PATH<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;/home/</span>$SERVICE_ACCOUNT<span style="color:#e6db74">/.ssh/id_rsa_</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    sudo chown <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">:</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;/home/</span>$SERVICE_ACCOUNT<span style="color:#e6db74">/.ssh/id_rsa_</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    sudo chmod <span style="color:#ae81ff">600</span> <span style="color:#e6db74">&#34;/home/</span>$SERVICE_ACCOUNT<span style="color:#e6db74">/.ssh/id_rsa_</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Private key not found at </span>$PRIVATE_KEY_PATH<span style="color:#e6db74">. Exiting.&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configure systemd user service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo -u <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> bash -c <span style="color:#e6db74">&#39;mkdir -p ~/.config/systemd/user&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF | sudo tee &#34;/home/$SERVICE_ACCOUNT/.config/systemd/user/$SERVICE_ACCOUNT.service&#34; &gt; /dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=SSH Reverse Tunnel for $SERVICE_ACCOUNT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/bin/ssh -i /home/$SERVICE_ACCOUNT/.ssh/id_rsa_$SERVICE_ACCOUNT -v -N \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -R $REMOTE_PORT:127.0.0.1:10050 -p $SERVER_PORT $SERVICE_ACCOUNT@$SERVER_ADDRESS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=default.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set ownership and permissions</span>
</span></span><span style="display:flex;"><span>sudo chown -R <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">:</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;/home/</span>$SERVICE_ACCOUNT<span style="color:#e6db74">/.config/systemd/user&#34;</span>
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#ae81ff">644</span> <span style="color:#e6db74">&#34;/home/</span>$SERVICE_ACCOUNT<span style="color:#e6db74">/.config/systemd/user/</span>$SERVICE_ACCOUNT<span style="color:#e6db74">.service&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable and start the service</span>
</span></span><span style="display:flex;"><span>sudo -u <span style="color:#e6db74">&#34;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#34;</span> bash -c <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # Initiate one time connection to the server so the service can start
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ssh -i ~/.ssh/id_rsa_&#39;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#39; -p &#39;</span>$SERVER_PORT<span style="color:#e6db74">&#39; -o StrictHostKeyChecking=no \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#39;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#39;@&#39;</span>$SERVER_ADDRESS<span style="color:#e6db74">&#39; true &gt; /dev/null 2&gt;&amp;1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    export XDG_RUNTIME_DIR=/run/user/$(id -u &#39;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    systemctl --user daemon-reload
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    systemctl --user enable --now &#39;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#39;.service &gt; /dev/null 2&gt;&amp;1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    systemctl --user status &#39;</span>$SERVICE_ACCOUNT<span style="color:#e6db74">&#39;.service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span>
</span></span></code></pre></div><p>The output should look like this:
<img src="/images/posts/zabbix-monitored-host-service.png" alt="Preview" title="preview">
If the <code>Active</code> part says <code>active (running)</code>, then you are good to go.</p>
<h3 id="on-the-frontend">On the frontend</h3>
<ol>
<li>Click on <code>Monitoring</code> â†’ <code>Hosts</code> on the sidebar.</li>
<li>Click on <code>Create host</code> button on right-top part of the page.</li>
<li>On the <code>Host</code> tab, fill in the <code>Host name</code> according to the hostname of the monitored host.</li>
<li>Click on <code>Select</code> button for <code>Host groups</code>.</li>
<li>Check one or more appropriate host group then click on <code>Select</code> button.</li>
<li>Under <code>Interface</code> section, click on <code>Add</code> then click on <code>Agent</code>.</li>
<li>Be sure to keep the <code>IP address</code> as is (127.0.0.1).</li>
<li>Change the <code>Port</code> according to your setup. Following the example above it should be <code>11051</code>.</li>
<li>Click on <code>Add</code> button at the bottom part of the form.</li>
</ol>
<p>A new entry should appear on your list. After around 10-15 seconds, the <code>Availability</code> value should change to <code>Available</code> (marked with ZBX green icon). This is the sign that the setup is working as expected.</p>

        </div>

        
        <div class="row ps-3 pe-3">
        
          <div class="col-md-6 share-buttons">
          
            <strong>Share on:</strong>
            
            <a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fmonitoring%2fzabbix-host-ssh%2f" target="_blank">
              <i class="fab fa-facebook"></i>
            </a>
            
            
                <a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmonitoring%2fzabbix-host-ssh%2f&text=Zabbix%3a%20monitor%20host%20over%20SSH&via=Moh.%20Sarip%20Hidayat%2c%20S.Tr.Kom" target="_blank">
                  <i class="fab fa-twitter"></i>
                </a>
            
            
                <a  class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmonitoring%2fzabbix-host-ssh%2f&title=Zabbix%3a%20monitor%20host%20over%20SSH" target="_blank">
                  <i class="fab fa-reddit"></i>
                </a>
            
            
            
            
                <a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmonitoring%2fzabbix-host-ssh%2f&title=Zabbix%3a%20monitor%20host%20over%20SSH" target="_blank">
                  <i class="fab fa-linkedin"></i>
                </a>
            
            
             
            
                 <a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Zabbix%3a%20monitor%20host%20over%20SSH http%3a%2f%2flocalhost%3a1313%2fposts%2fmonitoring%2fzabbix-host-ssh%2f" target="_blank">
                  <i class="fab fa-whatsapp"></i>
                </a>
            
            
                <a class="btn icon-button" href="mailto:?subject=Zabbix%3a%20monitor%20host%20over%20SSH&body=http%3a%2f%2flocalhost%3a1313%2fposts%2fmonitoring%2fzabbix-host-ssh%2f" target="_blank">
                  <i class="fas fa-envelope-open-text"></i>
                </a>
            
          
          </div>

        
        
          
            
          
          <div class="col-md-6 btn-improve-page">
             
               <a href="https://github.com/musahi0128/musahi0128.github.io/edit/main/content/posts/monitoring/zabbix-host-ssh.md" title="Improve this page" target="_blank" rel="noopener">
            
                <i class="fas fa-code-branch"></i>
                Improve this page
              </a>
          </div>
        
        </div>



      
      <hr />
        







  





  
  

  
  

  
  

  
    
    
  
  

  
  


<div class="row next-prev-navigator">
  
    <div class="col-md-6 previous-article">
      <a href="/posts/os/ubuntu/vncserver_wsl2/" title="VNC on WSL2" class="btn filled-button">
        <div><i class="fas fa-chevron-circle-left"></i> Prev</div>
        <div class="next-prev-text">VNC on WSL2</div>
      </a>
    </div>
  
  
      
      
        
      
      <div class="col-md-6 next-article">
        <a href="/posts/monitoring/zabbix-setup-script-noble-arm64/" title="Zabbix setup script for Ubuntu Noble ARM64/AArch64" class="btn filled-button">
          <div>Next <i class="fas fa-chevron-circle-right"></i></div>
          <div class="next-prev-text">Zabbix setup script for Ubuntu Noble ARM64/AArch64</div>
        </a>
      </div>
    
</div>

      <hr />

      
      
        
    











<script src="https://giscus.app/client.js"
        data-repo="musahi0128/musahi0128.github.io"
        data-repo-id="R_kgDONQ4Feg"
        data-category="General"
        data-category-id="DIC_kwDONQ4Fes4ClHBK"
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="dark"
        data-lang=""
        crossorigin="anonymous"
        async>
</script>





      

      
      

      </div>
    </div>
  </div>
  
  <a id="scroll-to-top" class="btn" type="button" data-bs-toggle="tooltip" data-bs-placement="left" title="Scroll to top">
    <i class="fas fa-chevron-circle-up"></i>
  </a>
</section>


      
      
  <section class="toc-section" id="toc-section">
    
    <div class="toc-holder">
      <h5 class="text-center ps-3">Table of Contents</h5>
      <hr>
      <div class="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#background">Background</a></li>
    <li><a href="#setting-up">Setting up</a>
      <ul>
        <li><a href="#on-the-server">On the server</a>
          <ul>
            <li><a href="#harden-ssh-service-config">Harden SSH service config</a></li>
            <li><a href="#prevent-brute-force-attack-with-fail2ban">Prevent brute-force attack with fail2ban</a></li>
            <li><a href="#setup-the-service-account">Setup the service account</a></li>
          </ul>
        </li>
        <li><a href="#on-the-monitored-host">On the monitored host</a></li>
        <li><a href="#on-the-frontend">On the frontend</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    </div>
    
  </section>

    </div>

    
    












  
  
    
  

  
  
    
  

  
  

  
  
    
    
      
    
  


  
  
  
    
  

  
  
  

  
  
  
    
  
  

  
  
  

  <footer id="footer" class="container-fluid text-center align-content-center footer pb-2">
    <div class="container pt-5">
      <div class="row text-start">
        
        <div class="col-md-4 col-sm-12">
          <h5>Navigation</h5>
          
          <ul>
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#about">About</a>
                </li>
              
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#skills">Skills</a>
                </li>
              
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#experiences">Experiences</a>
                </li>
              
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#education">Education</a>
                </li>
              
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#projects">Projects</a>
                </li>
              
              
              
              
              
                
                
                  
                
                <li class="nav-item">
                  <a class="smooth-scroll" href="http://localhost:1313/#accomplishments">Accomplishments</a>
                </li>
              
              
            
              
            
          </ul>
          
        </div>
        
        
        <div class="col-md-4 col-sm-12">
          <h5>Let&#39;s talk!</h5>
          <ul>
            
              
                <li><a href=mailto:musahi0128@gmail.com target="_blank" rel="noopener">
                  <span><i class="fas fa-envelope"></i></span> <span>musahi0128@gmail.com</span>
                </a></li>
              
            
              
                <li><a href=https://github.com/musahi0128 target="_blank" rel="noopener">
                  <span><i class="fab fa-github"></i></span> <span>musahi0128</span>
                </a></li>
              
            
              
                <li><a href=https://www.linkedin.com/in/musahi0128 target="_blank" rel="noopener">
                  <span><i class="fab fa-linkedin"></i></span> <span>Moh. Sarip Hidayat, S.Tr.Kom</span>
                </a></li>
              
            
              
                <li>
                  
                  <a href=https://wa.me/6285797412375 target="_blank" rel="noopener">
                    <span><i class=fab&#32;fa-fab&#32;fa-whatsapp></i></span> <span>&#43;6285797412375</span>
                  </a>
                  
                </li>
              
            
              
                <li>
                  
                  <a href=https://t.me/musahi0128 target="_blank" rel="noopener">
                    <span><i class=fab&#32;fa-fab&#32;fa-telegram></i></span> <span>musahi0128</span>
                  </a>
                  
                </li>
              
            
          </ul>
        </div>
        
        
        
      </div>
    </div>
    
    
    <hr />
    <div class="container">
      <div class="row text-start">
        <div class="col-md-4">
          <a id="theme" href="https://github.com/hugo-toha/toha" target="_blank" rel="noopener">
            <img src="/images/theme-logo_hu16779671404603505019.png" alt="Toha Theme Logo">
            Toha
          </a>
        </div>
        <div class="col-md-4 text-center">Â© 2024 Moh. Sarip Hidayat, S.Tr.Kom</div>
        <div class="col-md-4 text-end">
          <a id="hugo" href="https://gohugo.io/" target="_blank" rel="noopener">Powered by
          <img
            src="/images/hugo-logo.svg"
            alt="Hugo Logo"
            height="18"
          />
          </a>
        </div>
      </div>
    </div>
    
  </footer>


    <script src="/application.a301f9928083d4c2adfde9322c5ef4145d1a698e9333d5adc0626554b54fc4b9.js" integrity="sha256-owH5koCD1MKt/ekyLF70FF0aaY6TM9WtwGJlVLVPxLk=" defer></script>


    
     

    
    

</body>
</html>
